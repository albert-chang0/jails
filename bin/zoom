#!/usr/bin/bash
_CMD="$0"
_CMD_ABS="$(realpath "$_CMD")"
_ME="$(basename "$_CMD_ABS")"
_HOME="$(dirname "$_CMD_ABS")"
_LIB="${_HOME}/../lib/jails"

. "${_LIB}/common"

format_num() {
  printf "%03d" "$1"
}

check_perms

if [ $# -ne 2 ]; then
  printf "usage: %s <webcam_bus> <webcam_address>\n\n" "$_CMD"
  lsusb
  exit 1
fi

hostbus="$1"
hostaddr="$2"
shift 2

f_hostbus="$(format_num "$hostbus")"
f_hostaddr="$(format_num "$hostaddr")"
overlay_loc="${XDG_RUNTIME_DIR}/zoom.cow"

rm "$overlay_loc" &> /dev/null

qemu-img create -b "/opt/qemu/zoom.cow" -F qcow2 -f qcow2 "$overlay_loc" &> /dev/null
usb_dev="/dev/bus/usb/${f_hostbus}/${f_hostaddr}"
og="$(stat -c %u:%g "$usb_dev")"
chown "$(id -u):$(id -g)" "$usb_dev"
qemu-system-x86_64 -enable-kvm -m 2G -nic "user,hostfwd=tcp::2000-:22" -vga virtio -audiodev pa,id=snd0 -device ich9-intel-hda -device hda-duplex,audiodev=snd0 -device usb-ehci,id=ehci -device "usb-host,bus=ehci.0,hostbus=$hostbus,hostaddr=$hostaddr" -drive file="$overlay_loc",format=qcow2
rm "$overlay_loc" &> /dev/null

chown "$og" "$usb_dev"
